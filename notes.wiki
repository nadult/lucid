*Skupiamy się na wydajnym renderingu przezroczystości; Chcemy szybko zamknąć ten temat*

Aktualne cele:
- przeniesienie więcej kodu do wspólnych bibliotek; poprawienie raster.shader
- load balancing w raster_low: jak mamy 512 wątków, to możemy od razu wygenerować wszystkie segmenty
  i jak warp skończy przetwarzać jeden segment to może się przełączyć na kolejny
- precomputowanie danych dużych trisów (max 1M)
- wersja high
- wersja micro ?
- zaimplementowanie WB-OIT ?
- jakieś bardziej praktyczne testy: particle, particle przecinające się z normalną geometrią

- opisanie algorytmu
- wrzucenie gdzieś do sieci

-----------------------------------------------------------------------------------------
                                 === Co dalej ===
-----------------------------------------------------------------------------------------

- Na niektórych scenach bardziej opłaca się odpalić tylko wersję tile (jest szybciej)
  z czego to wynika?
  Opłaca się na: dragon, san-miguel
  Nie opłaca się na: sponza, conference, bunny

- Poprawna obsługa sytuacji gdy limity są przekraczane; Nie mogę robić za dużo wariantów, bo
  w efekcie będzie wolniej a nie szybciej

- Problem: jak sensownie obługiwać tile-e z dużą ilością trisów ?
  Czy wogóle chcę robić computeTiles, czy może lepiej generować to z poziomu raster_tile ?
  musiałbym sprawdzić?

-----------------------------------------------------------------------------------------
                         === Nie działające / nie pewne pomysły ===                      
-----------------------------------------------------------------------------------------

* Odnoszenie się do tile-row-trisów i nie generowanie tile-rowów
  BRAK PRZYSPIESZENIA w wersji 16x16, w wersji 16x4 nie da się tego łatwo zaimplementować...

? Precompute-owanie parametrów do scanline-a
  Czy dałoby się zrobić w fixed-point 16 bit ? A może 24 bity też ma sens?
  Fakt jest taki, że cała początkowa faza (process quads) na skomlikowanych scenach zajmuje ok 1%...
  W takim razie to chyba nie ma sensu...; Generowanie scanline-ów to pewnie mniej niż 25%...

* Prosta wersja alokatora pamięci bazującego na spin-locku w bin_dispatcherze jest wolniejsza
  niż nie do końca zoptymalizowana estymacja (powerplant: 100us vs 65us)

* Próby zbalansowania pracy przy binowaniu dużych quadów poprzez grupowanie quadów po wielkościach
  na 128 różnych grup praktycznie nic nie dały. Może dywergencja wielkości nie jest tak dużym problemem ?

-----------------------------------------------------------------------------------------
                                      === Statsy ===
-----------------------------------------------------------------------------------------

Wersja 16x4 2560x1330 (a82143f1 20.04):
            total  setup  bins  tiles  raster_bin
    #boxes: 1785   24     59    5      1624
     bunny: 571    69     52    5      382
conference: 1324   61     111   5      1007
    dragon: 957    187    72    100    276
    sponza: 3864   62     124   6      3521
    teapot: 536    28     45    5      414
 white_oak: 14794  54     263   6      14208


Wersja 16x4 2560x1330 raster_timings wyłączone (ae7a84ca 28.04):
             total  setup  bins  tiles  raster_bin
     #boxes: 1705   23     57    5      1541      
      bunny: 490    70     49    5      303       
 conference: 1342   61     109   5      1028      
conf-e(256): 1267   61     108   5      953       
     dragon: 918    188    66    100    236       
    gallery: 2451   216    75    121    1588      
     sponza: 3920   62     124   6      3568      
sponza(256): 3864   62     125   6      3510      
     teapot: 475    28     48    5      340       
  white_oak: 14091  51     251   6      13512     


Wersja 8x8 2560x1330 raster_timings wyłączone:
            total  setup  bins  tiles  raster_bin 
     #boxes: 1666   24     58    5      1512      (-2%)
      bunny: 500    69     49    5      300       (-1%)
 conference: 1343   62     110   5      1025      
conf-e(256): 1250   61     110   5      934       (-2%)
     dragon: 935    188    72    100    254       
    gallery: 2516   217    79    125    1650      
     sponza: 3892   63     126   6      3533      
sponza(256): 3818   63     123   6      3473      (-1%)
     teapot: 460    28     46    5      329       
  white_oak: 13962  51     254   7      13388     (-1%)

Shade zmergowane z reduce 2560x1330 raster_timings wyłączone:
            total  setup  bins  tiles  raster_bin  raster_tile  raster_block
    #boxes: 1656   24     59    5      1493        4            4
     bunny: 509    70     52    5      316         4            4
conference: 1346   62     112   5      1029        4            4
    dragon: 1087   188    72    99     253         400          4
   gallery: 3367   215    73    123    1666        1122         10
powerplant: 8724   1979   581   1454   771         3642         11
    sponza: 3872   63     126   6      3518        5            4
    teapot: 480    29     52    5      333         5            4
 white_oak: 13533  49     248   5      13084       5            4

Przywrócone segmenty 2560x1330 raster_timings wyłączone:
            total  setup  bins  tiles  raster_bin  raster_tile  raster_block
    #boxes: 1628   24     59    5      1466        4            4
     bunny: 486    70     48    5      303         4            4
conference: 1325   61     113   5      1011        4            4
    dragon: 1078   188    69    99     253         397          4
   gallery: 3398   217    74    126    1648        1130         10
powerplant: 8678   1990   568   1450   751         3683         11
    sponza: 3783   62     124   5      3429        4            4
    teapot: 468    27     49    5      327         4            4
 white_oak: 13352  51     252   6      12898       5            4

Optymalizacja setup & bins 2560x1330 raster_timings wyłączone:
            total  setup  bins  tiles  raster_bin  raster_tile  raster_block
    #boxes: 1648   24     56    5      1476        5            4
     bunny: 459    30     51    5      307         5            4
conference: 1347   45     136   5      1021        5            4
con-e(256): 1260   46     138   5      929         5            4
    dragon: 1050   136    60    105    261         419          4
   gallery: 3374   182    71    128    1656        1154         10
  hairball: 6285   543    199   1519   281         3616         16
powerplant: 8302   1511   195   1273   760         4317         11
san-miguel: 8197   944    199   697    1793        4347         11
    sponza: 3817   61     150   6      3450        5            4
spnza(256): 3756   61     151   6      3379        5            4
    teapot: 458    25     47    5      330         5            4
 white_oak: 13608  23     281   6      13127       5            4

Optymalizacja estymatora binów 2560x1330 raster_timings wyłączone:
            total  setup  bins  tiles  raster_bin  raster_tile quads bin-quads est    div
    #boxes: 1623   24     29    5      1494        5           6K     23K      11.2    4.86
     bunny: 431    30     26    5      305         5           29K    43K      12.3    2.86
conference: 1324   46     108   5      1027        4           11K    20K      35.8    17.9
    dragon: 1025   135    43    101    260         421        190K   248K      19.5    0.78
   gallery: 3369   181    59    128    1655        1159       314K   357K      24      0.067
  hairball: 6223   542    193   1511   278         3571      1484K  2304K      70      0.038
                                                             1050K   444K      95      0.213
powerplant: 8230   1513   186   1254   769         4297      1075K  1678K      63      0.037
san-miguel: 8134   944    179   687    1792        4305      1125K  1270K      69      0.054
    sponza: 3759   61     108   5      3425        4           24K    51K      41      0.8
    teapot: 443    25     24    5      329         4            8K    14K      11      0.78
 white_oak: 13304  24     181   6      12953       5           10K   126K      64      0.50


Podział na duże/małe trisy 2560x1330 raster_timings wyłączone:
            total  setup  bins  (small) tiles  raster_bin  raster_tile
    #boxes: 1613   24     31    100%    5      1479        4
     bunny: 450    29     35     95%    5      318         4
conference: 1288   46     85     36%    5      1020        4
    dragon: 1026   137    49     97%    101    259         411
   gallery: 3378   182    70     88%    130    1656        1153
  hairball: 6444   544    207    93%    1577   278         3723
powerplant: 8324   1528   175    73%    1257   764         4369
san-miguel: 8365   958    200    70%    688    1848        4417
    sponza: 3814   65     93     32%    6      3497        5
    teapot: 445    25     30     93%    5      333         5
 white_oak: 13492  25     136    25%    6      13182       5


 Optymalizacja w dispatcherze (używanie obliczonych countów z estymatora):
            total  setup  bins  tiles  raster_bin  raster_tile
    #boxes: 1612   24     30    4      1479        3
     bunny: 460    30     29    4      321         3
conference: 1289   46     75    4      1025        3
    dragon: 1062   138    51    113    261         418
   gallery: 3427   183    67    135    1677        1161
  hairball: 6577   544    228   1602   284         3736
powerplant: 8376   1523   170   1257   758         4461
san-miguel: 8389   958    175   737    1821        4428
 scrubPine: 656    13     34    5      543         3
    sponza: 3763   62     79    5      3449        3
    teapot: 464    25     28    4      330         3
 white_oak: 13474  23     104   5      13176       3

Binowanie dla 128x128 z wyłączonymi małymi quadami:
            total  setup  bins
    #boxes: 126    24     25
     bunny: 122    29     25
conference: 323    46     40
  hairball: 835    539    41
powerplant: 1951   1516   45
san-miguel: 1172   946    41
    sponza: 596    60     43
    teapot: 110    25     24
 white_oak: 1365   20     47

 Połączenie estymacji i dispatchowania; Przełączenie na biny 32x32
 (Niektóre sceny nie są renderowane w pełni):
             total  setup  bins  raster_bin
    #boxes: 1550   24     35    1440
     bunny: 393    29     34    284
conference: 1527   46     202   1150
    dragon: 906    137    71    654
   gallery: 2632   183    91    2207
  hairball: 1814   540    334   861
powerplant: 3391   1513   241   1499
san-miguel: 5319   955    318   3896
    sponza: 3927   63     215   3502
    teapot: 400    24     29    307
 white_oak: 13031  24     377   12495

 with rows:
             total  setup  bins  raster_bin
    #boxes: 1580   25     56    1447
     bunny: 400    29     38    287
conference: 1384   46     56    1157
  hairball: 1811   539    328   854
powerplant: 3474   1517   324   1506
    sponza: 3814   60     61    3533
 white_oak: 12683  22     124   12398

 without rows only segments:
            total  setup  bins  raster_bin
    #boxes: 1560   25     35    1451
     bunny: 393    29     30    287
conference: 1379   46     50    1157
    dragon: 899    137    58    652
   gallery: 2615   181    75    2203
  hairball: 1760   539    282   856
powerplant: 3420   1518   230   1536
san-miguel: 5198   955    188   3890
    sponza: 3852   62     83    3556
    teapot: 410    25     32    313
 white_oak: 12730  22     173   12398

 added raster_mid (eb0d8398ec), 32x32, 2560x1330, timery wyłączone:
             total  setup  bins  raster_low  raster_mid
    #boxes: 1507   25     34    1386        4
     bunny: 373    29     29    260         4
conference: 1211   45     49    989         4
    dragon: 967    135    56    523         197
   gallery: 2920   183    73    2033        452
  hairball: 12513  546    285   358         11180
powerplant: 12599  1520   231   801         9913
san-miguel: 8948   956    193   2542        5109
 scrubPine: 581    13     36    480         5
    sponza: 3739   63     82    3341        100
    teapot: 395    25     31    295         5
 white_oak: 13630  24     168   13133       5

 added scanline test to bin_dispatcher:
             total  setup  bins  raster_low  raster_mid
    #boxes: 1506   25     36    1389        4           
     bunny: 372    29     29    261         4
conference: 1381   45     216   990         4           +170
    dragon: 948    136    51    523         196         -20
   gallery: 2921   184    68    2039        455
  hairball: 12371  547    302   362         11069       -140
powerplant: 11604  1528   339   911         8712        -1000
san-miguel: 8765   956    214   2466        4985        -190
 scrubPine: 586    13     49    476         5
    sponza: 3867   61     217   3343        102         +70
    teapot: 401    25     32    296         5
 white_oak: 13132  25     380   12471       5           -500

 work-balancing in bin_dispatcher:                     improved bins:
            total  setup  bins  raster_low  raster_mid
    #boxes: 1521   25     39    1401        4
     bunny: 371    29     29    262         4
conference: 1252   45     76    1000        5           -140
    dragon: 961    137    51    526         197
   gallery: 2940   182    70    2047        453
  hairball: 12474  546    309   369         11087
powerplant: 11760  1526   346   903         8820        +8
san-miguel: 8886   964    179   2520        5040        -30
 scrubPine: 586    13     54    472         5           +5
    sponza: 3759   61     96    3331        100         -115
    teapot: 389    24     31    291         5
 white_oak: 12660  23     155   12347       4           -235


Data storage in quad_setup (initial version):
                 total  setup  bins  raster_low  raster_mid
         #boxes: 1551   129    42    1317        4
          bunny: 479    140    30    256         4
     conference: 1223   69     75    945         4
         dragon: 1395   610    50    457         217
        gallery: 4063   1610   69    1695        444
       hairball: 19974  8031   296   330         11118
     powerplant: 12972  3939   347   828         7662
     san-miguel: 11706  4695   187   2124        4512
      scrubPine: 562    26     60    430         5
         sponza: 3579   166    90    3072        100
         teapot: 510    139    35    293         5
      white_oak: 11110  99     153   10522       4

Improved task management in quad_setup:
            total  setup  bins  raster_low  raster_mid
    #boxes: 1478   37     41    1335        4
     bunny: 444    95     30    261         4
conference: 1233   67     74    961         4
    dragon: 1377   590    51    461         217
   gallery: 4068   1609   68    1709        451
  hairball: 19753  7631   293   326         11087
powerplant: 12900  3912   339   819         7655
san-miguel: 11492  4612   180   2077        4435
 scrubPine: 544    15     52    432         5
    sponza: 3587   152    91    3088        98
    teapot: 414    40     34    295         5
 white_oak: 10881  63     163   10498       5

 Added quad storage:
            total  setup  bins  raster_low  raster_mid
    #boxes: 1511   34     40    1380        4
     bunny: 428    86     29    251         5
conference: 1214   65     75    946         4
    dragon: 1241   509    50    425         200
   gallery: 3425   931    68    1776        458
  hairball: 15396  4511   295   311         10134
powerplant: 11795  3361   341   805         7096
san-miguel: 10470  3384   180   2150        4534
 scrubPine: 558    14     52    443         5
    sponza: 3694   124    85    3213        102
    teapot: 394    34     33    286         5
 white_oak: 11403  52     159   10885       4

 Added scan storage:
            total  setup  bins  raster_low  raster_mid
    #boxes: 1521   31     40    1388        4
     bunny: 416    79     30    253         4
conference: 1214   61     72    949         4
    dragon: 1136   458    50    387         188
   gallery: 3251   849    67    1720        428
  hairball: 13982  3673   299   310         9589
powerplant: 11373  3300   341   829         6638
san-miguel: 10132  3196   182   2165        4372
 scrubPine: 563    13     53    452         5
    sponza: 3694   116    89    3216        102
    teapot: 401    32     34    293         5
 white_oak: 11204  49     159   10836       4

 Passing cull_flags through bin_quads:
            total  setup  bins  raster_low  raster_mid
    #boxes: 1498   31     40    1367        4
     bunny: 412    78     29    246         4
conference: 1208   61     75    947         4
    dragon: 1110   461    50    369         176
   gallery: 3182   842    68    1670        410
  hairball: 13746  3696   299   301         9114
powerplant: 10963  3291   340   798         6403
san-miguel: 9893   3169   183   2138        4227
 scrubPine: 565    14     55    451         5
    sponza: 3728   119    89    3245        104
    teapot: 396    32     34    288         5
 white_oak: 11564  49     164   11001       5

Removed quad_indices & tri_aabbs:
            total  setup  bins  raster_low  raster_mid
    #boxes: 1487   29     37    1365        4
     bunny: 409    75     30    247         5
conference: 1195   59     68    935         4
    dragon: 1050   423    51    353         170
   gallery: 3079   785    67    1636        399
  hairball: 12983  3381   295   300         8920
powerplant: 10442  3023   280   790         6205
san-miguel: 9566   2926   182   2129        4150
 scrubPine: 557    13     51    447         5
    sponza: 3694   114    86    3226        101
    teapot: 395    31     31    286         5
 white_oak: 11211  45     171   10842       5

 Increased LSIZE in raster_medium to 1024:
            total  setup  bins  raster_low  raster_mid
    dragon: 1038   428    50    352         155
   gallery: 3002   787    66    1642        329
  hairball: 12534  3350   292   294         8386
powerplant: 10022  3023   280   786         5786
san-miguel: 9446   2905   179   2106        4081
